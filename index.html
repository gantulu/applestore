<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Webflow Product Cart</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; }
  .product-list { display:flex; flex-wrap:wrap; gap:16px; padding:16px; }
  .product-card { border:1px solid #ccc; padding:12px; width:200px; border-radius:8px; }
  .product-image-wrapper { width:100%; text-align:center; margin-bottom:8px; }
  .product-image { max-width:100%; height:auto; border-radius:4px; }
  .product-title { font-weight:bold; margin-bottom:4px; }
  .product-price { color:#333; }
  .product-sale-price { color:red; font-weight:bold; }
  .product-action { margin-top:8px; text-align:center; }
  .add-to-cart-btn { padding:6px 12px; border:none; background:#007BFF; color:white; border-radius:4px; cursor:pointer; }

  /* Modal */
  .cart-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
  .cart-modal.show { display:flex; }
  .cart-body { background:white; padding:24px; border-radius:8px; width:90%; max-width:500px; max-height:90%; overflow:auto; position:relative; }
  .close-cart { position:absolute; top:8px; right:8px; cursor:pointer; font-size:18px; font-weight:bold; }

  /* Cart form */
  .cart-label { display:block; margin:8px 0 4px; }
  .cart-input, .cart-select, .cart-textarea { width:100%; padding:6px; margin-bottom:8px; border:1px solid #ccc; border-radius:4px; }
  .cart-btn { padding:8px 16px; background:#28A745; color:white; border:none; border-radius:4px; cursor:pointer; width:100%; }
  .cart-continue-wrapper { margin-top:12px; }
  .cart-product { display:flex; gap:12px; margin-bottom:12px; }
  .cart-img { width:100px; border-radius:6px; }

  /* Description */
  .cart-description {
    margin-top: 12px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 6px;
    font-size: 14px;
    color: #555;
    line-height: 1.4em;
  }

  /* Animasi slide untuk customer form */
  .cart-customer {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: max-height 0.5s ease, opacity 0.5s ease;
  }
  .cart-customer.show {
    max-height: 1000px;
    opacity: 1;
  }
</style>
</head>
<body>

<div class="product-list"></div>

<div class="cart-modal">
  <div class="cart-body">
    <div class="close-cart">X</div>
  </div>
</div>

<script>
const apiURL = "https://opensheet.elk.sh/138LMOwLK7fTR4IBzaRglPkU-0bkrugUXW-7D4RNLJrA/iphone";
let allData = [];

function formatRM(num) {
  return "RM" + Number(num).toLocaleString('ms-MY');
}

fetch(apiURL)
  .then(res => res.json())
  .then(data => {
    allData = data;
    const groups = data.reduce((acc, item) => {
      const groupId = item.item_group_id || "Unknown Group";
      if (!acc[groupId]) acc[groupId] = item;
      return acc;
    }, {});

    const container = document.querySelector(".product-list");
    container.innerHTML = "";

    for (const groupId in groups) {
      const item = groups[groupId];
      const productCard = document.createElement("div");
      productCard.className = "product-card";
      productCard.innerHTML = `
        <div class="product-group">${groupId}</div>
        <div class="product-image-wrapper">
          <img class="product-image" src="${item.image_link}" alt="${item.title}" />
        </div>
        <div class="product-info">
          <div class="product-title">${item.title}</div>
          <div class="product-price">${formatRM(item.price)}</div>
          <div class="product-discount">${item.diskon}</div>
          <div class="product-sale-price">${formatRM(item.sale_price)}</div>
        </div>
        <div class="product-action">
          <button class="add-to-cart-btn" data-groupid="${groupId}">Add to Cart</button>
        </div>
      `;
      container.appendChild(productCard);
    }
  })
  .catch(err => {
    console.error("Error fetch data:", err);
    document.querySelector(".product-list").innerHTML = "<div class='load-error'>Gagal memuat data.</div>";
  });

// Event delegation
document.body.addEventListener("click", e => {
  if(e.target.classList.contains("add-to-cart-btn")) {
    const groupId = e.target.dataset.groupid;
    openCartModal(groupId);
    history.replaceState(null, '', `?itemgroupid=${groupId}`);
  }
  if(e.target.classList.contains("close-cart")) {
    closeCartModal();
  }
});

function closeCartModal() {
  const modal = document.querySelector(".cart-modal");
  modal.classList.remove("show");
  document.body.style.overflow = "";
  history.replaceState(null, '', window.location.pathname);
}

function openCartModal(groupId) {
  const modal = document.querySelector(".cart-modal");
  const cartBody = modal.querySelector(".cart-body");
  const variants = allData.filter(item => item.item_group_id === groupId);

  if (!variants.length) {
    cartBody.innerHTML = `<div class="close-cart">X</div><p>Tidak ada variant ditemukan.</p>`;
    modal.classList.add("show");
    document.body.style.overflow = "hidden";
    return;
  }

  const first = variants[0];
  const colors = [...new Set(variants.map(v => v.color).filter(Boolean))];
  const sizes = [...new Set(variants.map(v => v.size).filter(Boolean))];

  const formHTML = `
    <form class="cart-form">
      <div class="cart-product">
        <div class="cart-img-wrapper">
          <img class="cart-img" src="${first.image_link}" alt="${first.title}" />
        </div>
        <div>
          <div class="cart-title">${first.title}</div>
          <div class="cart-color">${first.color || '-'}</div>
          <div class="cart-size">${first.size || '-'}</div>
          <div class="cart-prices">
            <div class="cart-price">${formatRM(first.price)}</div>
            <div class="cart-sale-price">${formatRM(first.sale_price || first.price)}</div>
          </div>
        </div>
      </div>

      <div class="cart-selection">
        <label class="cart-label">Color</label>
        <select class="cart-select cart-select-color" name="color">
          ${colors.map(c => `<option value="${c}">${c}</option>`).join('')}
        </select>

        <label class="cart-label">Size</label>
        <select class="cart-select cart-select-size" name="size">
          ${sizes.map(s => `<option value="${s}">${s}</option>`).join('')}
        </select>
      </div>

      <!-- Description -->
      <div class="cart-description">
        ${first.description || "No description available for this product."}
      </div>

      <!-- Tombol Continue -->
      <div class="cart-continue-wrapper">
        <button type="button" class="cart-btn cart-continue-btn">Continue</button>
      </div>

      <!-- Bagian customer dengan animasi -->
      <div class="cart-customer">
        <label class="cart-label">Nama</label>
        <input class="cart-input cart-nama" name="nama" type="text" required>

        <label class="cart-label">WhatsApp</label>
        <input class="cart-input cart-whatsapp" name="whatsapp" type="text" required>

        <label class="cart-label">Email</label>
        <input class="cart-input cart-email" name="email" type="email" required>

        <label class="cart-label">Alamat Lengkap</label>
        <textarea class="cart-textarea cart-alamat" name="alamat" required></textarea>

        <label class="cart-label">Metode Pengiriman</label>
        <select class="cart-select cart-metode" name="metode" required>
          <option value="jne">JNE</option>
          <option value="pos">POS</option>
          <option value="tiki">TIKI</option>
        </select>

        <button type="submit" class="cart-btn checkout-btn">Checkout</button>
      </div>
    </form>
  `;

  cartBody.innerHTML = `<div class="close-cart">X</div>` + formHTML;
  modal.classList.add("show");
  document.body.style.overflow = "hidden";

  // Update variant on change
  const imgEl = cartBody.querySelector(".cart-img");
  const titleEl = cartBody.querySelector(".cart-title");
  const colorEl = cartBody.querySelector(".cart-color");
  const sizeEl = cartBody.querySelector(".cart-size");
  const priceEl = cartBody.querySelector(".cart-price");
  const saleEl = cartBody.querySelector(".cart-sale-price");
  const descEl = cartBody.querySelector(".cart-description");
  const selColor = cartBody.querySelector(".cart-select-color");
  const selSize = cartBody.querySelector(".cart-select-size");

  function update() {
    const col = selColor.value;
    const sz = selSize.value;
    const v = variants.find(x => x.color === col && x.size === sz);
    if (v) {
      imgEl.src = v.image_link;
      imgEl.alt = v.title;
      titleEl.textContent = v.title;
      colorEl.textContent = v.color || '-';
      sizeEl.textContent = v.size || '-';
      priceEl.textContent = formatRM(v.price);
      saleEl.textContent = formatRM(v.sale_price || v.price);
      descEl.textContent = v.description || "No description available for this product.";
    }
  }
  selColor.addEventListener('change', update);
  selSize.addEventListener('change', update);
  update();

  // Event Continue
  const continueBtn = cartBody.querySelector(".cart-continue-btn");
  const customerSection = cartBody.querySelector(".cart-customer");
  continueBtn.addEventListener("click", () => {
    customerSection.classList.add("show");
    continueBtn.parentElement.style.display = "none";
  });

  // Submit checkout
  cartBody.querySelector(".cart-form").addEventListener("submit", e => {
    e.preventDefault();
    const col = selColor.value;
    const sz = selSize.value;
    const v = variants.find(x => x.color === col && x.size === sz);
    if (v) {
      alert(`Checkout:\n${v.title}\n${v.color} / ${v.size}\nHarga: ${formatRM(v.sale_price || v.price)}`);
    } else {
      alert("Variant tidak ditemukan.");
    }
    closeCartModal();
  });
}

// Auto open modal jika ?itemgroupid ada
const urlParams = new URLSearchParams(window.location.search);
const itemGroupId = urlParams.get("itemgroupid");
if (itemGroupId) {
  openCartModal(itemGroupId);
}
</script>

</body>
</html>
